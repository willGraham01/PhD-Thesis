\section{Derivation of quantum graph problem} \label{sec:3DSystemDerivation}
We now look to find an alternative formulation to \eqref{eq:SingularCurlEquation}, which is more amenable to analysis.
Similarly to our working in section \ref{sec:ScalarDerivation}, the result will be a problem consisting of ODEs on the edges of $\graph$ coupled through the behaviour of incoming functions at the vertices.

Let $u=\bracs{u_1,u_2,u_3}^\top\in\ktcurlSob{\ddom}{\dddmes}$ and let $\Phi=\bracs{\phi_1,\phi_2,\phi_3}^\top\in\psmooth{\ddom}^3$.
Also define for each $I_{jk}\in\edgeSet$,
\begin{align*}
	U^{(jk)} := R_{jk} \begin{pmatrix} u_1^{(jk)} \\ u_2^{(jk)} \end{pmatrix},
	\qquad
	\Psi^{(jk)} := R_{jk} \begin{pmatrix} \phi_1^{(jk)} \\ \phi_2^{(jk)} \end{pmatrix}.
\end{align*}
We use an overhead tilde to denote composition with $r_{jk}$, and for a function $v$ with $\widetilde{v}^{(jk)}\in\ktgradSob{\sqbracs{0,l_{jk}}}{y}$ write $\bracs{v^{(jk)}}' := \bracs{\widetilde{v}^{(jk)}}' \circ r_{jk}^{-1}$.
Finally, for a given quasi-momentum $\qm$, set $\qm_{jk} = \bracs{ R_{jk}\qm }_2 = \qm\cdot e_{jk}$.
Immediately, we can notice that $u$ is tangentially-divergence free (definition \ref{def:DivFree-TangGradients}), since for any $v\in\ktgradSob{\ddom}{\dddmes}$ we can take an approximating sequence $\Phi^n$ for $v$ and obtain
\begin{align*}
	\omega^2\integral{\ddom}{ u\cdot\overline{\ktgrad_{\dddmes}v} }{\dddmes}
	&= \omega^2 \lim_{n\rightarrow\infty} \integral{\ddom}{ u\cdot\overline{\ktgrad\Phi^n} }{\dddmes} \\
	&= \lim_{n\rightarrow\infty} \integral{\ddom}{ \ktcurl{\dddmes}u\cdot\overline{\ktcurl{\dddmes}\bracs{\ktgrad\Phi^n}} }{\dddmes}
	= 0,
\end{align*}
through using lemma \ref{lem:CurlOfGradSmoothFunctions}.
Note that we cannot employ the same technique show that $u$ is orthogonal to all gradients of zero,, however we will see that the additional information (the conditions (i) and (iv) in proposition \ref{prop:DivFree-AllGradsConditions}) are obtained from the argument that follows.

Now let us fix an edge $I_{jk}$ and take $\Phi$ such that $\supp\Phi\cap\graph\subset I_{jk}^{\circ}$.
The equation \eqref{eq:SingularCurlEquation-VariationalForm} reduces to
\begin{align*}
	\omega^2 \integral{I_{jk}}{ u\cdot\overline{\Phi} }{\lambda_{jk}}
	&= \integral{I_{jk}}{ \ktcurl{\ddmes}u\cdot\overline{\ktcurl{\ddmes}\Phi} }{\lambda_{jk}} \\
	&= \integral{I_{jk}}{ \bracs{ \bracs{u_3^{(jk)}}' + \rmi\qm_{jk} u_3^{(jk)} - \rmi\wavenumber U_2^{(jk)} }\overline{\bracs{ \bracs{\phi_3^{(jk)}}' + \rmi\qm_{jk} \phi_3^{(jk)} - \rmi\wavenumber \Psi_2^{(jk)} }} }{\lambda_{jk}}.
\end{align*}
Using the change of variables $r_{jk}$ we obtain
\begin{align*}
	\int_0^{l_{jk}} & \bracs{ \bracs{\widetilde{u}_3^{(jk)}}' + \rmi\qm_{jk} \widetilde{u}_3^{(jk)} - \rmi\wavenumber \widetilde{U}_2^{(jk)} } \bracs{ \bracs{\overline{\widetilde{\phi}}_3^{(jk)}}' - \rmi\qm_{jk} \overline{\widetilde{\phi}}_3^{(jk)} + \rmi\wavenumber \overline{\widetilde{\Psi}}_2^{(jk)} } \ \md y \\
	&= \omega^2 \int_0^{l_{jk}} \widetilde{U}_1^{(jk)}\overline{\widetilde{\Psi}}_1^{(jk)} + \widetilde{U}_2^{(jk)}\overline{\widetilde{\Psi}}_2^{(jk)} + \widetilde{u}_3^{(jk)}\overline{\widetilde{\phi}}_3^{(jk)} \ \md y.
\end{align*}
Now suppose we have $\varphi_1,\varphi_2\in\csmooth{\sqbracs{0,l_{jk}}}$.
Since $R_{jk}\in\mathrm{SO}(2)$, the system
\begin{align*}
	\begin{pmatrix} \phi_1 \\ \phi_2 \end{pmatrix} &= R_{jk}^\top \begin{pmatrix} \varphi_1 \\ \varphi_2 \end{pmatrix}
\end{align*}
has a unique solution for $\bracs{\phi_1,\phi_2}^\top$, and we can construct a $\Phi\in\csmooth{\ddom}$ with $\supp\Phi\cap\graph\subset I_{jk}^{\circ}$, $\widetilde{\Psi}_1^{(jk)}=\varphi_1$, and $\widetilde{\Psi}_2^{(jk)}=\varphi_2$.
We thus observe that
\begin{align*}
	\int_0^{l_{jk}} & \bracs{ \bracs{\widetilde{u}_3^{(jk)}}' + \rmi\qm_{jk} \widetilde{u}_3^{(jk)} - \rmi\wavenumber \widetilde{U}_2^{(jk)} } \bracs{ \overline{\varphi_3}' - \rmi\qm_{jk} \overline{\varphi_3} + \rmi\wavenumber \overline{\varphi_2} } \ \md y \\
	&= \omega^2 \int_0^{l_{jk}} \widetilde{U}_1^{(jk)}\overline{\varphi_1} + \widetilde{U}_2^{(jk)}\overline{\varphi_2} + \widetilde{u}_3^{(jk)}\overline{\varphi_3} \ \md y
\end{align*}
holds for any $\varphi_1,\varphi_2,\varphi_3\in\csmooth{\sqbracs{0,l_{jk}}}$.
Therefore it must hold that for any $\varphi\in\csmooth{\sqbracs{0,l_{jk}}}$,
\begin{subequations}
	\begin{align*}
		0 &= \int_0^{l_{jk}} \overline{\varphi} \widetilde{U}_1^{(jk)} \ \md y, \labelthis\label{eq:CurlCurlWeakFormPhi1} \\
		0 &= \int_0^{l_{jk}} \overline{\varphi} \bracs{ \rmi\wavenumber\bracs{\widetilde{u}_3^{(jk)}}' + \bracs{\wavenumber^2 - \omega^2}\widetilde{U}_2^{(jk)} - \wavenumber\qm_{jk}\widetilde{u}_3^{(jk)}  } \ \md y, \labelthis\label{eq:CurlCurlWeakFormPhi2} \\
		0 &= \int_0^{l_{jk}} \overline{\varphi}' \bracs{ \bracs{\widetilde{u}_3^{(jk)}}'
		- \rmi\wavenumber\widetilde{U}_2^{(jk)} + \rmi\qm_{jk}\widetilde{u}_3^{(jk)} } \\
		&\qquad -\rmi\qm_{jk}\overline{\varphi}\bracs{ \bracs{\widetilde{u}_3^{(jk)}}' - \rmi\wavenumber\bracs{\widetilde{U}_2^{(jk)}}' + \rmi\qm_{jk}\widetilde{u}_3^{(jk)} }
		- \omega^2 \widetilde{u}_3^{(jk)}\overline{\varphi} \ \md y. \labelthis\label{eq:CurlCurlWeakFormPhi3}
	\end{align*}
\end{subequations}
The equation \eqref{eq:CurlCurlWeakFormPhi1} implies that $U_1^{(jk)}=0$ (almost everywhere) on $I_{jk}$, whilst \eqref{eq:CurlCurlWeakFormPhi2} implies that
\begin{align*}
	\rmi\wavenumber\bracs{\diff{}{y} + \rmi\qm_{jk}}\widetilde{u}_3^{(jk)} + \wavenumber^2\widetilde{U}_2^{(jk)} &= \omega^2\widetilde{U}_2^{(jk)},
\end{align*}
on $I_{jk}$.
Given that $u$ is divergence-free, we know that $\widetilde{U}_2^{(jk)}$ is weakly differentiable in the $\gradSob{\sqbracs{0,l_{jk}}}{y}$-sense and can manipulate \eqref{eq:CurlCurlWeakFormPhi3} to obtain
\begin{align*}
	\int_0^{l_{jk}} \overline{\varphi}' \widetilde{u}'_{3,jk} \ \md y
	&= -\int_0^{l_{jk}} \overline{\psi} \bracs{ \rmi\wavenumber\widetilde{U}'_{2,jk} - \wavenumber\qm_{jk}\widetilde{U}_{2,jk} - 2\rmi\qm_{jk}\widetilde{u}'_{3,jk} + \qm_{jk}^2\widetilde{u}_{3,jk} - \omega^2\widetilde{u}_{3,jk} } \ \md y.,
\end{align*}
for all $\varphi\in\csmooth{\sqbracs{0,l_{jk}}}$.
Thus we can conclude that $\widetilde{u}_3\in\gradgradSob{\sqbracs{0,l_{jk}}}{y}$, from which we deduce that
\begin{align*}
	-\bracs{ \diff{}{y} + \rmi\qm_{jk} }^2\widetilde{u}_3^{(jk)} + \rmi\wavenumber\bracs{ \diff{}{y} + \rmi\qm_{jk} }\widetilde{U}_2^{(jk)} &= \omega^2 \widetilde{u}_3^{(jk)}
\end{align*}
on $I_{jk}$.
This provides us with a system of coupled ODEs on each of the edges $I_{jk}$ (and the information that the component $\widetilde{U}_1^{(jk)}=0$ on each edge).

Now we look at how these edge ODEs are coupled at the vertices.
Fix a vertex $v_j$ and consider a $\Phi\in\csmooth{\ddom}$ whose support contains $v_j$ in its interior, and no other vertices of $\graph$.
Testing against such $\Phi$ in \eqref{eq:SingularCurlEquation-VariationalForm} implies that
\begin{align*}
	\alpha_j\omega^2 u(v_j)\cdot\overline{\Phi}(v_j)
	&= \integral{\ddom}{ \ktcurl{\ddmes}u\cdot\overline{\ktcurl{\ddmes}\Phi} - \omega^2 u\cdot\overline{\Phi} }{\ddmes} \\
	&= \sum_{j\con k}\integral{I_{jk}}{ \bracs{ \bracs{u_3^{(jk)}}' + \rmi\qm_{jk}u_3^{(jk)} - \rmi\wavenumber U_2^{(jk)}} \bracs{ \bracs{\overline{\phi}_3^{(jk)}}' - \rmi\qm_{jk}\overline{\phi}_3^{(jk)} + \rmi\wavenumber \overline{\Psi}_2^{(jk)}} \\
	&\qquad - \omega^2 U_1^{(jk)}\overline{\Psi}_1 - \omega^2 U_2^{(jk)}\overline{\Psi}_2 - \omega^2 u_3^{(jk)}\overline{\phi}_3 }{\lambda_{jk}} \\
	&= \sum_{j\con k}\int_0^{l_{jk}} \bracs{ \bracs{\widetilde{u}_3^{(jk)}}' + \rmi\qm_{jk}\widetilde{u}_3^{(jk)} - \rmi\wavenumber \widetilde{U}_2^{(jk)}} \bracs{ \bracs{\overline{\widetilde{\phi}}_3^{(jk)}}' - \rmi\qm_{jk}\overline{\widetilde{\phi}}_3^{(jk)} + \rmi\wavenumber \overline{\widetilde{\Psi}}_2^{(jk)}} \\
	&\qquad - \bracs{\bracs{\widetilde{u}_3^{(jk)}}' + \rmi\qm_{jk}\widetilde{u}_3^{(jk)} - \rmi\wavenumber \widetilde{U}_2^{(jk)}}\rmi\wavenumber\overline{\widetilde{\Psi}_2^{(jk)}} - \omega^2 \widetilde{u}_3^{(jk)}\overline{\widetilde{\phi}}_3 \ \md y \\
	&= -\sum_{j\con k}\int_0^{l_{jk}} \overline{\widetilde{\phi}}_3
	\sqbracs{ \bracs{\widetilde{u}_3^{(jk)}}'' + 2\rmi\qm_{jk}\bracs{\widetilde{u}_3^{(jk)}}' + \bracs{\rmi\qm_{jk}}^2\widetilde{u}_3^{(jk)} + \omega^2\widetilde{u}_3^{(jk)} } \\
	&\qquad - \overline{\widetilde{\phi}}_3\sqbracs{\rmi\wavenumber\bracs{ \bracs{\widetilde{U}_2^{(jk)}}' + \rmi\qm_{jk}\widetilde{U}_2^{(jk)} } } \ \md y \\
	&\qquad + \overline{\phi}_3(v_j)\sqbracs{ \sum_{j\con k}\bracs{\pdiff{}{n}+\rmi\qm_{jk}}u_3^{(jk)}(v_j) + \sum_{j\conRight k}U_2^{(kj)}(v_j) - \sum_{j\conLeft k}U_2^{(jk)}(v_j) } \\
	&= \overline{\phi}_3(v_j)\sqbracs{ \sum_{j\con k}\bracs{\pdiff{}{n}+\rmi\qm_{jk}}u_3^{(jk)}(v_j) + \sum_{j\conRight k}U_2^{(kj)}(v_j) - \sum_{j\conLeft k}U_2^{(jk)}(v_j) },
\end{align*}
where $U_2^{(jk)}(v_j)$ is the trace of $U_2^{(jk)}$ to the vertex $v_j$.
Identifying that this holds for all $\phi_1(v_j), \phi_2(v_j), \phi_3(v_j)\in\complex$, we must conclude that
\begin{align*}
	u_1(v_j) &= 0, \\
	u_2(v_j) &= 0, \\
	\alpha_j\omega^2u_3(v_j) &= \sum_{j\con k}\bracs{\pdiff{}{n}+\rmi\qm_{jk}}u_3^{(jk)}(v_j) + \sum_{j\conRight k}U_2^{(kj)}(v_j) - \sum_{j\conLeft k}U_2^{(jk)}(v_j).
\end{align*}
We are thus presented with the following set of equations on each edge $I_{jk}$;
\begin{subequations} \label{eq:QGRawSystem}
	\begin{align*}
		\widetilde{U}_1^{(jk)} &= 0 \\
		\rmi\wavenumber \bracs{ \diff{}{y} + \rmi\qm_{jk} }\widetilde{u}_3^{(jk)} + \wavenumber^2\widetilde{U}_2^{(jk)} &= \omega^2\widetilde{U}_2^{(jk)}, \labelthis\label{eq:QGPhi2} \\
		-\bracs{ \diff{}{y} + \rmi\qm_{jk} }^2\widetilde{u}_3^{(jk)} + \rmi\wavenumber\bracs{ \diff{}{y} + \rmi\qm_{jk} }\widetilde{U}_2^{(jk)} &= \omega^2 \widetilde{u}_3^{(jk)}, \labelthis\label{eq:QGPhi3} 
	\end{align*}
	complemented by the vertex conditions
	\begin{align*}
		\widetilde{u}_3 \text{ is continuous at } v_j &\quad\forall v_j\in\vertSet, \labelthis\label{eq:QGContinuity} \\
		u_1(v_j) &= 0, \\
		u_2(v_j) &= 0, \\
		\alpha_j \omega^2 u_3\bracs{v_j}
		&= \sum_{j\con k} \bracs{ \pdiff{}{n} + \rmi\qm_{jk} }u_3^{(jk)}\bracs{v_j} - \rmi\wavenumber\bracs{ \sum_{j\conRight k} U_2^{(jk)} - \sum_{j\conLeft k} U_2^{(jk)} }. \labelthis\label{eq:QGVertexCondition}
	\end{align*}
\end{subequations}

Determining the solution to \eqref{eq:QGRawSystem} requires us to find the function $u_3$ and the edge-functions $U_2^{(jk)}$.
However we can eliminate the $U_2^{(jk)}$ from the system \eqref{eq:QGRawSystem} via substitution of \eqref{eq:QGPhi2} into \eqref{eq:QGPhi3}, and use of corollary \ref{cory:DivFree-TangGradsConditions}(v), to obtain
\begin{subequations} \label{eq:CurlCurl-ScalarQGProblem}
	\begin{align}
		-\bracs{ \diff{}{y} + \rmi\qm_{jk} }^2 u_3^{(jk)} &= \bracs{\omega^2-\wavenumber^2}u,
		\qquad &\text{on each } I_{jk}, \\
		u_3 \text{ is continuous at } & v_j \qquad &\forall v_j\in\vertSet, \\
		\sum_{j\con k}\bracs{\pdiff{}{n}+\rmi\qm_{jk}}u_3^{(jk)}(v_j) &= \alpha_j\bracs{\omega^2-\wavenumber^2}u_3(v_j), \qquad &\forall v_j\in\vertSet.
	\end{align}
\end{subequations}
The system \eqref{eq:SingularCurlEquation} has reduced to the scalar system obtained in section \ref{sec:ScalarDerivation}, except with $\omega^2-\wavenumber^2$ playing the role of the spectral parameter.
We have already surveyed and explored the methods one can employ for studying \eqref{eq:CurlCurl-ScalarQGProblem} in chapter \ref{ch:ScalarSystem}, so whilst we know how to solve this problem, there is nothing new to be done on the numerical side.
In this regard, it is regrettable and surprising that our analysis of the curl-of-the-curl system has resulted in us obtaining what is essentially the acoustic approximation.
Even when we do not consider oblique waves (for which $\kappa=0)$), we still find that we have this reduction to a scalar system, which does not occur for the classical Maxwell system or curl of the curl equation.
Having said this, we have ultimately still managed to obtain the solvable (and realisable) system \eqref{eq:CurlCurl-ScalarQGProblem} through the analysis of sections \ref{sec:CC-CurlAnalysis} and \ref{sec:DivFreeCondition}, and non-trivial manipulations of unfamiliar objects like $\ktcurl{\dddmes}u$.
This demonstrates that, even if we are forced to accept rather uncomfortable-sounding statements like all vector fields are divergence free (see section \ref{sec:DivFreeCondition}), our approach to the postulation and solution of variational problems on singular structures is consistent and provides a coherent framework for the handling of such problems.
We will continue to discuss the implications of \eqref{eq:CurlCurl-ScalarQGProblem}, and reach an a posteriori understanding as to why we have obtained it, in \ref{sec:CC-Discussion}.